<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>鋼管重量計算（コピー対応）</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
    }
    button {
      margin-top: 10px;
      margin-right: 10px;
    }
    .copy-message {
      color: green;
      font-size: 0.9em;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h2>鋼管重量計算（1mあたり）</h2>

  <table id="pipeTable">
    <thead>
      <tr>
        <th>外径 (mm)</th>
        <th>肉厚 (mm)</th>
        <th>材質</th>
        <th>比重</th>
        <th>理論重量 (kg/m)</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <!-- 初期行がここに追加される -->
    </tbody>
  </table>

  <div>
    <button onclick="addRow()">＋ 行を追加</button>
    <button onclick="copyResults()">📋 結果をコピー</button>
    <span id="copyMessage" class="copy-message"></span>
  </div>

  <script>
    const materials = {
      '炭素鋼': 7850,
      'ステンレス304': 7930,
      'ステンレス316': 8000,
      '銅': 8900,
      'アルミ': 2700,
      '鋳鉄': 7200,
      '塩ビ': 1400,
      'PE': 950,
      'チタン': 4500
    };

    function createMaterialOptions() {
      return Object.entries(materials).map(([name, value]) => {
        return `<option value="${value}">${name}</option>`;
      }).join('');
    }

    function addRow() {
      const row = document.createElement('tr');

      row.innerHTML = `
        <td><input type="number" step="0.1" class="od" value="114.3"></td>
        <td><input type="number" step="0.1" class="thickness" value="6.02"></td>
        <td>
          <select class="material">
            ${createMaterialOptions()}
          </select>
        </td>
        <td><input type="number" step="1" class="density" value="7850"></td>
        <td class="weight">-</td>
      `;

      const inputs = row.querySelectorAll('input, select');
      inputs.forEach(input => {
        input.addEventListener('input', () => calculateRow(row));
        input.addEventListener('change', () => {
          if (input.classList.contains('material')) {
            const densityInput = row.querySelector('.density');
            densityInput.value = input.value;
          }
          calculateRow(row);
        });
      });

      document.getElementById('tableBody').appendChild(row);
      calculateRow(row);
    }

    function calculateRow(row) {
      const od = parseFloat(row.querySelector('.od').value);
      const t = parseFloat(row.querySelector('.thickness').value);
      const density = parseFloat(row.querySelector('.density').value);
      const resultCell = row.querySelector('.weight');

      if (isNaN(od) || isNaN(t) || isNaN(density) || t * 2 >= od) {
        resultCell.textContent = '-';
        return;
      }

      const id = od - 2 * t;
      const volume = (Math.PI / 4) * (od ** 2 - id ** 2) * 1e-6;
      const weight = volume * density;

      resultCell.textContent = weight.toFixed(3);
    }

    function copyResults() {
      const resultCells = document.querySelectorAll('.weight');
      const weights = Array.from(resultCells)
        .map(cell => cell.textContent.trim())
        .filter(w => w !== '-' && w !== '');

      if (weights.length === 0) {
        showCopyMessage("コピー対象がありません", false);
        return;
      }

      const text = weights.join('\n');
      navigator.clipboard.writeText(text).then(() => {
        showCopyMessage("コピーしました！", true);
      }).catch(() => {
        showCopyMessage("コピー失敗", false);
      });
    }

    function showCopyMessage(message, success) {
      const msgEl = document.getElementById('copyMessage');
      msgEl.textContent = message;
      msgEl.style.color = success ? 'green' : 'red';
      setTimeout(() => msgEl.textContent = '', 3000);
    }

    // 初期行を追加
    addRow();
  </script>
</body>
</html>
